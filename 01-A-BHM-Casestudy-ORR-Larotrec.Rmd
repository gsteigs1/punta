---
title: "01-A-BHM-Casestudy-ORR-Larotrectinib"
author: "Sandro Gsteiger"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 7
    highlight: 'default'
    reference_docx: word_template.docx
    toc: yes
    toc_depth: 4
  # html_document:
  #   toc: true
  #   toc_float: true
  #   number_sections: true
  # editor_options: 
  #   chunk_output_type: console
knit: (function(inputFile, encoding) {rmarkdown::render(inputFile, encoding = encoding, output_dir = "outputs")})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

rm(list = ls())

library(readxl)
library(dplyr)
library(reshape2)
library(R2jags)
library(ggplot2)

for(s in dir("R")){
  source(file.path(".", "R", s))
}

r_seed <- 8945334
```

# Description

Reproduce Bayesian hierarchical model for Larotrectinib ORR data from ERG analysis, NICE STA Committee papers (ID1299).

In addition:  

* Fit fixed effects (FE) meta-analysis (MA) model.
* Fit random effects (RE) meta-analysis (MA) with alternative prior 1: Half-normal(sigma = 1). 
* Fit random effects (RE) meta-analysis (MA) with alternative prior 2: Half-normal(sigma = 0.5).
* Fit RE MA models to subset of data where only tissues with at least one event and one non-event retained.
* Fit RE MA models to subset of data where only tissues with sample size >= 5 are retained.


The half-normal HN(sigma) is defined as: HN(sigma) = abs(N(Mean = 0, Var = sigma^2))

# Reproduce ERG meta-analysis of ORR data
Read in response rate data extracted from ERG report in NICE Committee papers.

__Table__ ORR data included in BHM by ERG
```{r, results='asis'}
dorr_erg <- read_excel("data/Larotrectinib-ORR.xlsx", sheet = "ERG-Table7") %>%
  mutate(orr = x / n)
pander::pandoc.table(dorr_erg, row.names = FALSE, split.tables = Inf, justify = "lrrl", digits = 2)
```

Total sample size matches ERG analysis: `r sum(dorr_erg$n)`.


Global parameters for BHM.
```{r, echo=TRUE}
djags <- list(ns = nrow(dorr_erg),
              r = dorr_erg$x,
              n = dorr_erg$n)

n_chains <- 3
n_iter <- 15000
n_burnin <- 2000
n_thin <- 1

pars_fe <- c("mu", "p.pop", "p", "theta", "theta.new", "p.new")
```

Priors selected by ERG, see Section 4.6 (ERG report page 66 (which is page 490 in Committee papers pdf)).

**Note:** there are two inconsistencies in the ERG report page 66 regarding prior distributions: 

1. "The prior distribution for p was centred around a probability of 0.3 (a log-odds of -1.3863)".
-> logit(0.3) = -0.847
-> inv.logit(-1.3863) ~= 0.2 (which sounds low)
I select p=0.3.

2. They sey they have selected a uniform prior U(0,5) for the random effects variance as suggested by Cunanan (2019). But the recommendation from Cunanan is to put this prior on the heterogeneity sd, not on the var. I will put the U(0,5) on the sd. This leads to the same results as and in particular to the same predictive distribution of a new effect as presented by the ERG. Therefore, I believe the ERG did, in their modelling, put the prior on the sd, while the text contains a slight error.


```{r}
erg_priors <- list(
  prior.fe.mean = boot::logit(0.3),
  prior.fe.prec = 1/10,
  prior.re.lo = 0,
  prior.re.up = 5
)
```

Fit the random effects MA model used by the ERG.
```{r}
set.seed(r_seed)
fit_re <- jags(data = c(djags, erg_priors),
               n.chains = n_chains,
               n.iter = n_iter,
               n.burnin = n_burnin,
               n.thin = n_thin,
               parameters = c(pars_fe, "re.sd"),
               inits = NULL,
               model.file = "models/bin_abs_re_unif.jgmod")
```


__Results: reproducing the ERG analysis__

```{r}
# extract results and derive summaries needed later on for tables and figures

## print the (BUGS) output summaries: RE model
# fit_re

## summaries as in forest plots
sum_re <- get_bin_forestdata(fit_re, node.stem = "p", study.labs = dorr_erg$`Tumour type`)

## threshold probabilities
p_better_re <- get_bin_threshold(fit_re, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                 node.stem = "p", node.extras = c(".pop", ".new"), 
                                 study.labs = dorr_erg$`Tumour type`)

## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re, 
                         node.stem = "p", 
                         study.labs = dorr_erg$`Tumour type`, 
                         var.name = "Tumour_type")

## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")
```


__Table__ Reproducing ERG analysis: Study specific estimates
```{r, results='asis'}
pander::pandoc.table(sum_re, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ Reproducing ERG analysis: Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```

__Table__ Reproducing ERG analysis: Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re, row.names = FALSE, split.tables = Inf, digits = 3, justify = "left")
```


__Figure__ Reproducing ERG analysis: Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


__Figure__ Reproducing ERG analysis: Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = c(erg_priors$prior.re.lo, erg_priors$prior.re.up),
                     y = rep(1/diff(c(erg_priors$prior.re.lo, erg_priors$prior.re.up)), 2))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, dprior, fig)
```



# For comparison: corresponding fixed effect model
```{r}
set.seed(r_seed)
fit_fe <- jags(data = c(djags, erg_priors[1:2]),
               n.chains = n_chains,
               n.iter = n_iter,
               n.burnin = n_burnin,
               n.thin = n_thin,
               parameters = pars_fe,
               inits = NULL,
               model.file = "models/bin_abs_fe.jgmod")
```

__Results: FE model__

```{r}
## print the (BUGS) output summaries: RE model
# fit_fe

## summaries as in forest plots
sum_fe <- get_bin_forestdata(fit_fe, node.stem = "p", study.labs = dorr_erg$`Tumour type`)

## threshold probabilities
p_better_fe <- get_bin_threshold(fit_fe, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                 node.stem = "p", node.extras = c(".pop", ".new"), 
                                 study.labs = dorr_erg$`Tumour type`)

```


__Table__ FE model estimates
```{r, results='asis'}
pander::pandoc.table(sum_fe, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ FE model: Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_fe %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```

__Table__ FE model: Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_fe, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ FE model: Density estimates of response probability per tissue
```{r}
dsims <- get_bin_samples(fit_fe, 
                         node.stem = "p", 
                         study.labs = dorr_erg$`Tumour type`, 
                         var.name = "Tumour_type")

fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


# Alternative prior 1: HN(sigma = 1)
Use the same priors for the population mean mu, but instead of the U(0,5) for RE SD, use a half-normal(sigma = 1).

```{r}
my_priors <- list(
  prior.fe.mean = boot::logit(0.3),
  prior.fe.prec = 1/10,
  prior.re.mean = 0,
  prior.re.prec = 1
)
  
set.seed(3 * r_seed)
fit_re_hn <- jags(data = c(djags, my_priors),
               n.chains = n_chains,
               n.iter = n_iter,
               n.burnin = n_burnin,
               n.thin = n_thin,
               parameters = c(pars_fe, "re.sd"),
               inits = NULL,
               model.file = "models/bin_abs_re_hn.jgmod")
```


__Results: Alternative RE prior 1: HN(sigma = 1)__

```{r}
## print the (BUGS) output summaries: RE model
# fit_re_hn

## summaries as in forest plots
sum_re_hn <- get_bin_forestdata(fit_re_hn, node.stem = "p", study.labs = dorr_erg$`Tumour type`)

## threshold probabilities
p_better_re_hn <- get_bin_threshold(fit_re_hn, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_erg$`Tumour type`)

## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_hn, 
                         node.stem = "p", 
                         study.labs = dorr_erg$`Tumour type`, 
                         var.name = "Tumour_type")


## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_hn, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ Alternative RE prior 1: HN(sigma = 1): response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_hn, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ Alternative RE prior 1: HN(sigma = 1): Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_hn %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ Alternative RE prior 1: HN(sigma = 1): Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_hn, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ Alternative RE prior 1: HN(sigma = 1): Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


__Figure__ Alternative RE prior 1: HN(sigma = 1): Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = seq(0, 5, 0.1)) %>%
  mutate(y = 2 * dnorm(x, 
                       mean = my_priors$prior.re.mean, 
                       sd = sqrt(1/my_priors$prior.re.prec)))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, dprior, fig)
```

# Alternative prior 2: HN(sigma = 0.5)
Use the same priors for the population mean mu, but instead of the U(0,5) for RE SD, use a half-normal(sigma = 0.5).

```{r}
my_priors2 <- list(
  prior.fe.mean = boot::logit(0.3),
  prior.fe.prec = 1/10,
  prior.re.mean = 0,
  prior.re.prec = 1 / (0.5^2)
)
  
set.seed(7 * r_seed)
fit_re_hn2 <- jags(data = c(djags, my_priors2),
               n.chains = n_chains,
               n.iter = n_iter,
               n.burnin = n_burnin,
               n.thin = n_thin,
               parameters = c(pars_fe, "re.sd"),
               inits = NULL,
               model.file = "models/bin_abs_re_hn.jgmod")
```


__Results: Alternative RE prior 2: HN(sigma = 0.5)__

```{r}
## print the (BUGS) output summaries: RE model
# fit_re_hn2

## summaries as in forest plots
sum_re_hn2 <- get_bin_forestdata(fit_re_hn2, node.stem = "p", study.labs = dorr_erg$`Tumour type`)

## threshold probabilities
p_better_re_hn2 <- get_bin_threshold(fit_re_hn2, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_erg$`Tumour type`)

## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_hn2, 
                         node.stem = "p", 
                         study.labs = dorr_erg$`Tumour type`, 
                         var.name = "Tumour_type")


## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_hn2, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ Alternative RE prior 2: HN(sigma = 0.5): response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_hn2, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ Alternative RE prior 2: HN(sigma = 0.5): Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_hn2 %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ Alternative RE prior 2: HN(sigma = 0.5): Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_hn2, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ Alternative RE prior 2: HN(sigma = 0.5): Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


__Figure__ Alternative RE prior 2: HN(sigma = 0.5): Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = seq(0, 5, 0.1)) %>%
  mutate(y = 2 * dnorm(x, 
                       mean = my_priors2$prior.re.mean, 
                       sd = sqrt(1/my_priors2$prior.re.prec)))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, dprior, fig)
```


# At least one event/non-event (but with ERG prior)
ERG model applied to a reduced data set: contains only tissue types with at least 1 event and 1 non-event. This means the analysis data set is the following.

__Table__ ORR data (reduced set)
```{r, results='asis'}
dorr_sub <- dorr_erg %>%
  filter(x >= 1, n - x >= 1)

pander::pandoc.table(dorr_sub, row.names = FALSE, split.tables = Inf, justify = "lrlr", digits = 2)
```


```{r}
djags_sub <- list(ns = nrow(dorr_sub),
                  r = dorr_sub$x,
                  n = dorr_sub$n)

set.seed(4 * r_seed)
fit_re_sub <- jags(data = c(djags_sub, erg_priors),
                   n.chains = n_chains,
                   n.iter = n_iter,
                   n.burnin = n_burnin,
                   n.thin = n_thin,
                   parameters = c(pars_fe, "re.sd"),
                   inits = NULL,
                   model.file = "models/bin_abs_re_unif.jgmod")
```


__Results: Reduced data set__

```{r}
## summaries as in forest plots
sum_re_sub <- get_bin_forestdata(fit_re_sub, node.stem = "p", study.labs = dorr_sub$`Tumour type`)

## threshold probabilities
p_better_re_sub <- get_bin_threshold(fit_re_sub, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_sub$`Tumour type`)

## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_sub, 
                         node.stem = "p", 
                         study.labs = dorr_sub$`Tumour type`, 
                         var.name = "Tumour_type")

## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_sub, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ Reduced data set: response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_sub, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ Reduced data set: Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_sub %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ Reduced data set: Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_sub, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ Reduced data set: Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```

__Figure__ Reduced data set: Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = c(erg_priors$prior.re.lo, erg_priors$prior.re.up),
                     y = rep(1/diff(c(erg_priors$prior.re.lo, erg_priors$prior.re.up)), 2))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, fig)
```


# At least one event/non-event and with alternative prior 1: HN(sigma = 1)

```{r}
set.seed(5 * r_seed)
fit_re_sub_hn <- jags(data = c(djags_sub, my_priors),
                   n.chains = n_chains,
                   n.iter = n_iter,
                   n.burnin = n_burnin,
                   n.thin = n_thin,
                   parameters = c(pars_fe, "re.sd"),
                   inits = NULL,
                   model.file = "models/bin_abs_re_hn.jgmod")
```


__Results: Reduced data set and Alternative RE prior 1: HN(sigma = 1)__

```{r}
## summaries as in forest plots
sum_re_sub_hn <- get_bin_forestdata(fit_re_sub_hn, node.stem = "p", study.labs = dorr_sub$`Tumour type`)

## threshold probabilities
p_better_re_sub_hn <- get_bin_threshold(fit_re_sub_hn, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_sub$`Tumour type`)
## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_sub_hn, 
                         node.stem = "p", 
                         study.labs = dorr_sub$`Tumour type`, 
                         var.name = "Tumour_type")

## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_sub_hn, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ Reduced data set and Alternative RE prior 1: HN(sigma = 1): response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_sub_hn, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ Reduced data set and Alternative RE prior 1: HN(sigma = 1): Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_sub_hn %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ Reduced data set and Alternative RE prior 1: HN(sigma = 1): Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_sub_hn, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ Reduced data set and Alternative RE prior 1: HN(sigma = 1): Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


__Figure__ Reduced data set and Alternative RE prior 1: HN(sigma = 1): Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = seq(0, 5, 0.1)) %>%
  mutate(y = 2 * dnorm(x, 
                       mean = my_priors$prior.re.mean, 
                       sd = sqrt(1/my_priors$prior.re.prec)))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, dprior, fig)
```


# At least one event/non-event and with alternative prior 2: HN(sigma = 0.5)

```{r}
set.seed(8 * r_seed)
fit_re_sub_hn2 <- jags(data = c(djags_sub, my_priors2),
                   n.chains = n_chains,
                   n.iter = n_iter,
                   n.burnin = n_burnin,
                   n.thin = n_thin,
                   parameters = c(pars_fe, "re.sd"),
                   inits = NULL,
                   model.file = "models/bin_abs_re_hn.jgmod")
```


__Results: Reduced data set and Alternative RE prior 2: HN(sigma = 0.5)__

```{r}
## summaries as in forest plots
sum_re_sub_hn2 <- get_bin_forestdata(fit_re_sub_hn2, node.stem = "p", study.labs = dorr_sub$`Tumour type`)

## threshold probabilities
p_better_re_sub_hn2 <- get_bin_threshold(fit_re_sub_hn2, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_sub$`Tumour type`)
## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_sub_hn2, 
                         node.stem = "p", 
                         study.labs = dorr_sub$`Tumour type`, 
                         var.name = "Tumour_type")

## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_sub_hn2, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ Reduced data set and Alternative RE prior 2: HN(sigma = 0.5): response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_sub_hn2, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ Reduced data set and Alternative RE prior 2: HN(sigma = 0.5): Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_sub_hn2 %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ Reduced data set and Alternative RE prior 2: HN(sigma = 0.5): Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_sub_hn2, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ Reduced data set and Alternative RE prior 2: HN(sigma = 0.5): Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


__Figure__ Reduced data set and Alternative RE prior 2: HN(sigma = 0.5): Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = seq(0, 5, 0.1)) %>%
  mutate(y = 2 * dnorm(x, 
                       mean = my_priors2$prior.re.mean, 
                       sd = sqrt(1/my_priors2$prior.re.prec)))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, dprior, fig)
```



# Minimal size of 5 (but with ERG prior)
ERG model applied to a reduced data set: contains only tissue types with at least five observations. This means the analysis data set is the following.

__Table__ ORR data (reduced to tissues with size >= 5)
```{r, results='asis'}
dorr_sub2 <- dorr_erg %>%
  filter(n >= 5)

pander::pandoc.table(dorr_sub2, row.names = FALSE, split.tables = Inf, justify = "lrlr", digits = 2)
```


```{r}
djags_sub2 <- list(ns = nrow(dorr_sub2),
                  r = dorr_sub2$x,
                  n = dorr_sub2$n)

set.seed(4 * r_seed)
fit_re_sub2 <- jags(data = c(djags_sub2, erg_priors),
                   n.chains = n_chains,
                   n.iter = n_iter,
                   n.burnin = n_burnin,
                   n.thin = n_thin,
                   parameters = c(pars_fe, "re.sd"),
                   inits = NULL,
                   model.file = "models/bin_abs_re_unif.jgmod")
```


__Results: subset (n>=5)__

```{r}
## summaries as in forest plots
sum_re_sub2 <- get_bin_forestdata(fit_re_sub2, node.stem = "p", study.labs = dorr_sub2$`Tumour type`)

## threshold probabilities
p_better_re_sub2 <- get_bin_threshold(fit_re_sub2, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_sub2$`Tumour type`)

## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_sub2, 
                         node.stem = "p", 
                         study.labs = dorr_sub2$`Tumour type`, 
                         var.name = "Tumour_type")

## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_sub2, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ subset (n>=5): response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_sub2, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ subset (n>=5): Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_sub2 %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ subset (n>=5): Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_sub2, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ subset (n>=5): Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```

__Figure__ subset (n>=5): Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = c(erg_priors$prior.re.lo, erg_priors$prior.re.up),
                     y = rep(1/diff(c(erg_priors$prior.re.lo, erg_priors$prior.re.up)), 2))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, fig)
```


# Minimal size of 5 and with alternative prior 1: HN(sigma = 1)

```{r}
set.seed(5 * r_seed)
fit_re_sub2_hn <- jags(data = c(djags_sub2, my_priors),
                   n.chains = n_chains,
                   n.iter = n_iter,
                   n.burnin = n_burnin,
                   n.thin = n_thin,
                   parameters = c(pars_fe, "re.sd"),
                   inits = NULL,
                   model.file = "models/bin_abs_re_hn.jgmod")
```


__Results: subset (n>=5) and Alternative RE prior 1: HN(sigma = 1)__

```{r}
## summaries as in forest plots
sum_re_sub2_hn <- get_bin_forestdata(fit_re_sub2_hn, node.stem = "p", study.labs = dorr_sub2$`Tumour type`)

## threshold probabilities
p_better_re_sub2_hn <- get_bin_threshold(fit_re_sub2_hn, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_sub2$`Tumour type`)
## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_sub2_hn, 
                         node.stem = "p", 
                         study.labs = dorr_sub2$`Tumour type`, 
                         var.name = "Tumour_type")

## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_sub2_hn, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ subset (n>=5) and Alternative RE prior 1: HN(sigma = 1): response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_sub2_hn, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ subset (n>=5) and Alternative RE prior 1: HN(sigma = 1): Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_sub2_hn %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ subset (n>=5) and Alternative RE prior 1: HN(sigma = 1): Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_sub2_hn, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ subset (n>=5) and Alternative RE prior 1: HN(sigma = 1): Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


__Figure__ subset (n>=5) and Alternative RE prior 1: HN(sigma = 1): Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = seq(0, 5, 0.1)) %>%
  mutate(y = 2 * dnorm(x, 
                       mean = my_priors$prior.re.mean, 
                       sd = sqrt(1/my_priors$prior.re.prec)))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, dprior, fig)
```


# Minimal size of 5 and with alternative prior 2: HN(sigma = 0.5)

```{r}
set.seed(8 * r_seed)
fit_re_sub2_hn2 <- jags(data = c(djags_sub2, my_priors2),
                   n.chains = n_chains,
                   n.iter = n_iter,
                   n.burnin = n_burnin,
                   n.thin = n_thin,
                   parameters = c(pars_fe, "re.sd"),
                   inits = NULL,
                   model.file = "models/bin_abs_re_hn.jgmod")
```


__Results: subset (n>=5) and Alternative RE prior 2: HN(sigma = 0.5)__

```{r}
## summaries as in forest plots
sum_re_sub2_hn2 <- get_bin_forestdata(fit_re_sub2_hn2, node.stem = "p", study.labs = dorr_sub2$`Tumour type`)

## threshold probabilities
p_better_re_sub2_hn2 <- get_bin_threshold(fit_re_sub2_hn2, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_sub2$`Tumour type`)
## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_sub2_hn2, 
                         node.stem = "p", 
                         study.labs = dorr_sub2$`Tumour type`, 
                         var.name = "Tumour_type")

## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_sub2_hn2, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ subset (n>=5) and Alternative RE prior 2: HN(sigma = 0.5): response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_sub2_hn2, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ subset (n>=5) and Alternative RE prior 2: HN(sigma = 0.5): Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_sub2_hn2 %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ subset (n>=5) and Alternative RE prior 2: HN(sigma = 0.5): Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_sub2_hn2, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ subset (n>=5) and Alternative RE prior 2: HN(sigma = 0.5): Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


__Figure__ subset (n>=5) and Alternative RE prior 2: HN(sigma = 0.5): Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = seq(0, 5, 0.1)) %>%
  mutate(y = 2 * dnorm(x, 
                       mean = my_priors2$prior.re.mean, 
                       sd = sqrt(1/my_priors2$prior.re.prec)))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, dprior, fig)
```





# Compare posterior inferences across RE fits
```{r}
allfits <- list("U(0,5)"                         = fit_re,
                "HN(1)"   = fit_re_hn,
                "HN(0.5)" = fit_re_hn2,
                "Event/non-event and U(0,5)"                   = fit_re_sub,
                "Event/non-event and HN(1)"   = fit_re_sub_hn,
                "Event/non-event and HN(0.5)" = fit_re_sub_hn2,
                "Min. size 5 and U(0,5)"                   = fit_re_sub2,
                "Min. size 5 and HN(1)"   = fit_re_sub2_hn,
                "Min. size 5 and HN(0.5)" = fit_re_sub2_hn2)
```


__Table__ Compare RE SD posterior summaries across models
```{r, results='asis'}
## re.se posterior summaries
post_slist <- lapply(allfits, get_quantiles, node = "re.sd")
post_mat <- matrix(unlist(post_slist),
                     nrow = length(allfits),
                     byrow = TRUE)
post_all <- data.frame(Model = names(allfits), 
                         post_mat)
names(post_all)[-1] <- names(post_slist[[1]])

pander::pandoc.table(post_all, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)

rm(post_slist, post_mat, post_all)
```


__Table__ Compare p.new posterior summaries across models
```{r, results='asis'}
## p.new posterior summaries
post_slist <- lapply(allfits, get_quantiles, node = "p.new")
post_mat <- matrix(unlist(post_slist),
                     nrow = length(allfits),
                     byrow = TRUE)
post_all <- data.frame(Model = names(allfits), 
                         post_mat)
names(post_all)[-1] <- names(post_slist[[1]])

pander::pandoc.table(post_all, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)

rm(post_slist, post_mat, post_all)
```


__Table__ Compare threshold probabilities: Prob(p.new >= threshold)
```{r, results='asis'}
## threshold probabilities: p.new
post_slist <- lapply(allfits, get_bin_threshold, 
                     thresholds = 1:9/10, 
                     node.stem = NULL, 
                     node.extras = "p.new", 
                     study.labs = NULL)

post_mat <- matrix(unlist(post_slist),
                   nrow = length(allfits),
                   byrow = TRUE)

post_all <- data.frame(Model = names(allfits), 
                       post_mat)
names(post_all)[-1] <- stringr::str_replace(names(post_slist[[1]]), "ProbAbove", ">=")

post_all <- post_all %>% select(-node)

pander::pandoc.table(post_all, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Table__ Compare threshold probabilities: Prob(p.new < threshold)
```{r, results='asis'}
post_mat <- 1 - post_mat
post_all <- data.frame(Model = names(allfits), 
                       post_mat)
names(post_all)[-1] <- stringr::str_replace(names(post_slist[[1]]), "ProbAbove", "<")

post_all <- post_all %>% select(-node)

pander::pandoc.table(post_all, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```



(__Table__ Compare input data sets)
```{r, results='asis'}

# number of tissues
# pooled n
# pooled x
# naive pool: obs rate and CI
  
```


# Cumulative meta-analysis
## Background
Assess the impact of adding tissues with very low sample size. Intuitively, one would expect that as more and more tissue types become available, the data becomes more and more informative. However, by adding tissues with very small group size one may actually introduce more heterogeneity (as suggested by SA1 and SA2). 

Illustrate this by doing a cumulative MA and studying the range of the predictive distribution.

Use the U(0, 5) prior from the ERG - the least informative prior from the case study - since the objective is to assess estimability of $\tau$ from the data. Therefore use "as little prior information as possible".

## Data and "procedure"

Recall the ORR data used by the ERG.
```{r}
# ORR data used by ERG
dorr_erg 
```

I will do a cumulative MA starting with the RE MA model fitted to the first 3 tissues (in the order given above), then to the first four, then five and so on.

## Run the cumulative MA

Global parameters for BHM.

```{r, echo=TRUE}
n_chains <- 3
n_iter <- 30000 # 15000 # double the iterations since for initial fits data limited
n_burnin <- 4000 # 2000
n_thin <- 2 # 1
```


```{r, echo=FALSE}
set.seed(r_seed)

cma_fits <- list()

for(i in 3:nrow(dorr_erg)){
  dorr_erg_i <- dorr_erg[1:i,]
  djags_i <- list(ns = nrow(dorr_erg_i),
                  r = dorr_erg_i$x,
                  n = dorr_erg_i$n)
  
  fit_re_i <- jags(data = c(djags_i, erg_priors),
                   n.chains = n_chains,
                   n.iter = n_iter,
                   n.burnin = n_burnin,
                   n.thin = n_thin,
                   parameters = c(pars_fe, "re.sd"),
                   inits = NULL,
                   model.file = "models/bin_abs_re_unif.jgmod")
  
  cma_fits[[i-2]] <- fit_re_i
  rm(fit_re_i)
}
```

## Cumulative MA results

### Posterior summaries of rates (population and new tissue) and of RE SD

```{r}
# Initialize data frames to store results
cma_pnew <- as.data.frame(matrix(NA, # predictive distribution (response rate in new tissue)
                                 nrow = nrow(dorr_erg) - 2, ncol = 11, 
                                 dimnames = list(NULL, c("n_tissues", "n_tot", 
                                                         "dn", "dr", 
                                                         "2.5%",  "25%",   "50%",   "75%",   "97.5%",
                                                         "IQR",   "CrIR"))),
                          
                          check.names = FALSE)
cma_ppop <- cma_pnew                 # population response rate

cma_resd <- as.data.frame(matrix(NA, # random effect SD (tau)
                                 nrow = nrow(dorr_erg) - 2, ncol = 8, 
                                 dimnames = list(NULL, c("n_tissues", "n_tot", 
                                                         "dn", "dr",
                                                         "mean", "sd",
                                                         "IQR",   "CrIR"))),
                          
                          check.names = FALSE)


for (i in 1:length(cma_fits)){
  fit_re_i <- cma_fits[[i]]
  dorr_erg_i <- dorr_erg[1:(i+2),]
  dsums_i <- c(n_tissues = i+2,
               n_tot = sum(dorr_erg_i$n),
               dn    = tail(dorr_erg_i$n, 1),
               dr    = tail(dorr_erg_i$x, 1)
               #r_tot = sum(dorr_erg_i$x)
               )
  
  
  qts_pnew_i <- get_quantiles(fit_re_i, node = "p.new")
  qts_ppop_i <- get_quantiles(fit_re_i, node = "p.pop")
  qts_resd_i <- get_quantiles(fit_re_i, node = "re.sd")
  psum_resd_i <- fit_re_i$BUGSoutput$summary["re.sd", c("mean", "sd")]
  
  cma_pnew[i,] <- c(dsums_i, qts_pnew_i) 
  cma_ppop[i,] <- c(dsums_i, qts_ppop_i) 
  cma_resd[i,] <- c(dsums_i, psum_resd_i, qts_resd_i[c("IQR", "CrIR")]) 
 
  rm(fit_re_i, dorr_erg_i)
}

```


__Table__ Cumulative MA results: posterior summaries p.new
```{r, results='asis'}
pander::pandoc.table(cma_pnew, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Table__ Cumulative MA results: posterior summaries p.pop
```{r, results='asis'}
pander::pandoc.table(cma_ppop, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Table__ Cumulative MA results: posterior summaries re.sd
```{r, results='asis'}
pander::pandoc.table(cma_resd, row.names = FALSE, split.tables = Inf, justify = "left", digits = 2)
```

Compare this with the U(0, 5) prior summaries:
__Table__ Summaries of U(0,5) prior
```{r, results='asis'}
duprior <- data.frame(mean = 2.5,
                      sd = sqrt(25/12),
                      IQR = 2.5,
                      CrIR = 4.75)

pander::pandoc.table(duprior, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```

### Shrinkage
Exchangeability is assumed on the logit scale, therefore also shrinkage of the estimates should be calculated on the logit scale. For tissues no. 8 and 10 - 14 this is not possible since the observed rates are 0 or 1 and the shrinkage and shrinkage factors are not properly defined. Therefore, I calculate the shrinkage for the first seven tissues and show how it evolves in the cumulative MA. 

#### Shrinkage factors
I first use shrinkage factors to quantify shrinkage on a relative and therefore interpretable scale. 

**Fully Bayesian version**
Shrinkage factor:

$$ \omega_i = \frac{\theta_i - y_i}{\mu - y_i } $$

For each round in the cumulative MA, for each of the first seven tissue types (when available), calculate the full posterior of $\omega_i$ and derive posterior summaries (take the mean and the median).

Shrinkage factor $\omega_i$ of 0 indicates no shrinkage to the population mean of the meta-analysis estimate for tissue $i$ (the BHM estimate stays at $y_i$, the estimate when considering this tissue in isolation). A shrinkage factor of 1 indicates complete shrinkage meaning the tissue specific estimate from the BHM model collapses with the population estimate.

More shrinkage - larger values of omega - also mean more borrowing of information across tissues.

Note that for some tissues, the observed rate may be close to the population estimate leading to denominator values close to zero in the calculation of the shrinkage factor. For some tissues, these factors using plug-in estimates may, therefore, be numerically unstable and depend for example on whether the posterior mean or median is taken as point estimate.

Also, the population estimate $\hat\mu$ still evolves quite a lot in the cumulative MA where with start with three tissues only. Therefore the normalization is not really a "normalization constant", which makes interpretation not as straightforward as one may think.

**Approximation using plug-in estimates**

Shrinkage factor:
$$ \hat\omega_i = \frac{\hat\theta_i - y_i}{\hat\mu - y_i } $$
where
$y_i$ the observed response rate in tissue $i$ on the logit scale;
$\hat\theta_i$ a point estimate of the true response rate in tissue $i$ (on the logit scale);
and $\mu$ the corresponding population estimate.

Point estimates would typically be the posterior median or the posterior mean.


#### Absolute shrinkage
As seen, the shrinkage factors have two limitations:

* Numerical issues due to some tissues having observed estimate close to the population mean.
* Normalizing not with a constant.

Therefore, I also assess the abolute shrinkage, defined as the difference between the observed rate and tissue specific rate estimate (both on the logit scale) from the MA:
$$ \Omega_i = |\theta_i - y_i| $$

Again, larger values show more shrinkage, i.e. more borrowing of information. Lower values mean less borrowing of information across tissues.

This has the additional advantage that proper posterior summaries of $\Omega_i$ can be obtained via plug-in estimates given the piecewise linear structure.


#### Results
```{r}
# extract the estimates (logit scale) for the first 7 tissues 
#  for all MAs (where they exist)

n_shrink <- 7
n_skip <- 2
n_cma <- length(cma_fits)

dshrinkage <- data.frame()
for(i in 1:n_cma){
  
  fit_re_i <- cma_fits[[i]]
  est_pop_med_i <- fit_re_i$BUGSoutput$summary["mu", "50%"]
  est_pop_mean_i <- fit_re_i$BUGSoutput$summary["mu", "mean"]
  
  for(j in 1:min(n_shrink, i + n_skip)){
    #cat("i:", i, ", j:", j, "\n")
    obs_j <- boot::logit(dorr_erg[[j, "orr"]])
    type_j <- dorr_erg[[j, "Tumour type"]]
    
    name_j <- paste("theta[", j, "]", sep = "")
    est_grp_med_ij <- fit_re_i$BUGSoutput$summary[name_j, "50%"]
    est_grp_mean_ij <- fit_re_i$BUGSoutput$summary[name_j, "mean"]
    
    # shrinkage factors (plug-in)
    shrinkage_med_ij <- (est_grp_med_ij - obs_j) / (est_pop_med_i - obs_j)
    shrinkage_mean_ij <- (est_grp_mean_ij - obs_j) / (est_pop_mean_i - obs_j)
    
    
    # shrinkage factors (fully Bayesian) 
    srfB_ij <- get_shrinkage(fit_re_i,  node.pop = "mu", node.grp = "theta", id.grp = j)  

    # absolute shrinkage
    absshrinkage_med_ij <- abs(est_grp_med_ij - obs_j)
    absshrinkage_mean_ij <- abs(est_grp_mean_ij - obs_j)
    
    
    out_ij <- data.frame("cma_id" = i,
                         "tissue_id" = j,
                         "n_tissues" = i + n_skip, 
                         "tissue"    = type_j,
                         "srkf_med_ij" = shrinkage_med_ij,
                         "srkf_mean_ij"= shrinkage_mean_ij,
                         "srkf_B_med_ij" = srfB_ij[["median"]],
                         "srkf_B_mean_ij"= srfB_ij[["mean"]],
                         "asrk_med_ij" = absshrinkage_med_ij,
                         "asrk_mean_ij"= absshrinkage_mean_ij,
                         stringsAsFactors = FALSE)
    
    dshrinkage <- rbind(dshrinkage, out_ij)
  }
}
```


__Table__ Shrinkage results across the cumulative MA 
```{r, results='asis'}
pander::pandoc.table(dshrinkage, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


##### Shrinkage factors (approximate with plug-in estimates)

_First seven tissues_

__Figure__ Approximate shrinkage factors by tissue type (posterior median as plug-in estimate)
```{r}
ggplot(data = dshrinkage) +
  geom_line(aes(x = n_tissues, y = srkf_med_ij, color = tissue)) +
  ylim(-0.25, 1.25) +
  scale_x_continuous(breaks = 3:14) +
  labs(y = "Shrinkage factor",
       x = "No tissues") +
  theme_bw() +
  theme(legend.title = element_blank())

```

__Figure__ Approximate shrinkage factors by tissue type (posterior mean as plug-in estimate)
```{r}
ggplot(data = dshrinkage) +
  geom_line(aes(x = n_tissues, y = srkf_mean_ij, color = tissue)) +
  ylim(-0.25, 1.25) +
  scale_x_continuous(breaks = 3:14) +
  labs(y = "Shrinkage factor",
       x = "No tissues") +
  theme_bw() +
  theme(legend.title = element_blank())

```

Borrowing of information increases initially as more, relatively homogeneous tissues are added to the MA. 
After reaching a peak, borrowing decreases again. Despite adding more tissues, the mutual sharing of information goes down since the (estimated) heterogeneity increases when adding small, low information tissues.

_First three tissues (which can be followed all along the cumulative MA)_

__Figure__ Approximate shrinkage factors by tissue type (posterior median as plug-in estimate)
```{r}
ggplot(data = dshrinkage %>% filter(tissue_id <=3)) +
  geom_line(aes(x = n_tissues, y = srkf_med_ij, color = tissue)) +
  ylim(-0.25, 1.25) +
  scale_x_continuous(breaks = 3:14) +
  labs(y = "Shrinkage factor",
       x = "No tissues") +
  theme_bw() +
  theme(legend.title = element_blank())
```

__Figure__ Approximate shrinkage factors by tissue type (posterior mean as plug-in estimate)
```{r}
ggplot(data = dshrinkage %>% filter(tissue_id <=3)) +
  geom_line(aes(x = n_tissues, y = srkf_mean_ij, color = tissue)) +
  ylim(-0.25, 1.25) +
  scale_x_continuous(breaks = 3:14) +
  labs(y = "Shrinkage factor",
       x = "No tissues") +
  theme_bw() +
  theme(legend.title = element_blank())
```

##### Shrinkage factors (fully Bayesian)

_First seven tissues_

__Figure__ Shrinkage factors by tissue type (posterior median)
```{r}
ggplot(data = dshrinkage) +
  geom_line(aes(x = n_tissues, y = srkf_B_med_ij, color = tissue)) +
  ylim(0, 1) +
  scale_x_continuous(breaks = 3:14) +
  labs(y = "Shrinkage factor",
       x = "No tissues") +
  theme_bw() +
  theme(legend.title = element_blank())

```
Borrowing of information initially increases (larger shrinkage factor). But when adding the low information tissue types, borrowing of information across tissue types decreases again (shrinkage factor goes down).



__Figure__ Approximate shrinkage factors by tissue type (posterior mean)
```{r}
ggplot(data = dshrinkage) +
  geom_line(aes(x = n_tissues, y = srkf_B_mean_ij, color = tissue)) +
  #ylim(-0.25, 1.25) +
  scale_x_continuous(breaks = 3:14) +
  labs(y = "Shrinkage factor",
       x = "No tissues") +
  theme_bw() +
  theme(legend.title = element_blank())
```
-> the ratio in the shrinkage factor makes the calculation somewhat numerically unstable; posterior means cannot be used reliably




##### Absolute shrinkage

_First seven tissues_

__Figure__ Absolute shrinkage (posterior medians)
```{r}
ggplot(data = dshrinkage) +
  geom_line(aes(x = n_tissues, y = asrk_med_ij, color = tissue)) +
  #ylim(-0.25, 1.25) +
  scale_x_continuous(breaks = 3:14) +
  labs(y = "Absolute shrinkage",
       x = "No tissues") +
  theme_bw() +
  theme(legend.title = element_blank())
```

__Figure__ Absolute shrinkage (posterior means)
```{r}
ggplot(data = dshrinkage) +
  geom_line(aes(x = n_tissues, y = asrk_mean_ij, color = tissue)) +
  #ylim(-0.25, 1.25) +
  scale_x_continuous(breaks = 3:14) +
  labs(y = "Absolute shrinkage",
       x = "No tissues") +
  theme_bw() +
  theme(legend.title = element_blank())
```

_First three tissues (which can be followed across the full cumulative MA)_

__Figure__ Absolute shrinkage (posterior medians)
```{r}
ggplot(data = dshrinkage %>% filter(tissue_id <=3)) +
  geom_line(aes(x = n_tissues, y = asrk_med_ij, color = tissue)) +
  #ylim(-0.25, 1.25) +
  scale_x_continuous(breaks = 3:14) +
  labs(y = "Absolute shrinkage",
       x = "No tissues") +
  theme_bw() +
  theme(legend.title = element_blank())
```

__Figure__ Absolute shrinkage (posterior means)
```{r}
ggplot(data = dshrinkage %>% filter(tissue_id <=3)) +
  geom_line(aes(x = n_tissues, y = asrk_mean_ij, color = tissue)) +
  #ylim(-0.25, 1.25) +
  scale_x_continuous(breaks = 3:14) +
  labs(y = "Absolute shrinkage",
       x = "No tissues") +
  theme_bw() +
  theme(legend.title = element_blank())
```




# Session info
```{r}
getwd()
sessionInfo()
```
