---
title: "01-A-BHM-Casestudy-ORR-Larotrectinib"
author: "Sandro Gsteiger"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  word_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 7
    highlight: 'default'
    reference_docx: word_template.docx
    toc: yes
    toc_depth: 4
  # html_document:
  #   toc: true
  #   toc_float: true
  #   number_sections: true
  # editor_options: 
  #   chunk_output_type: console
knit: (function(inputFile, encoding) {rmarkdown::render(inputFile, encoding = encoding, output_dir = "outputs")})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

rm(list = ls())

library(readxl)
library(dplyr)
library(reshape2)
library(R2jags)
library(ggplot2)

for(s in dir("R")){
  source(file.path(".", "R", s))
}

r_seed <- 8945334
```

# Description

Reproduce Bayesian hierarchical model for Larotrectinib ORR data from ERG analysis, NICE STA Committee papers (ID1299).

In addition:  

* Fit fixed effects (FE) meta-analysis (MA) model.
* Fit random effects (RE) meta-analysis (MA) with alternative prior (half-normal(0, 1)).
* Fit RE MA models to subset of data where only tissues with at least one event and one non-event retained.

# Reproduce ERG meta-analysis of ORR data
Read in response rate data extracted from ERG report in NICE Committee papers.

__Table__ ORR data included in BHM by ERG
```{r, results='asis'}
dorr_erg <- read_excel("data/Larotrectinib-ORR.xlsx", sheet = "ERG-Table7") %>%
  mutate(orr = x / n)
pander::pandoc.table(dorr_erg, row.names = FALSE, split.tables = Inf, justify = "lrrl", digits = 2)
```

Total sample size matches ERG analysis: `r sum(dorr_erg$n)`.


Global parameters for BHM.
```{r, echo=TRUE}
djags <- list(ns = nrow(dorr_erg),
              r = dorr_erg$x,
              n = dorr_erg$n)

n_chains <- 3
n_iter <- 15000
n_burnin <- 2000
n_thin <- 1

pars_fe <- c("mu", "p.pop", "p", "theta", "theta.new", "p.new")
```

Priors selected by ERG, see Section 4.6 (ERG report page 66 (which is page 490 in Committee papers pdf)).

**Note:** there are two inconsistencies in the ERG report page 66 regarding prior distributions: 

1. "The prior distribution for p was centred around a probability of 0.3 (a log-odds of -1.3863)".
-> logit(0.3) = -0.847
-> inv.logit(-1.3863) ~= 0.2 (which sounds low)
I select p=0.3.

2. They sey they have selected a uniform prior U(0,5) for the random effects variance as suggested by Cunanan (2019). But the recommendation from Cunanan is to put this prior on the heterogeneity sd, not on the var. I will put the U(0,5) on the sd. This leads to the same results as and in particular to the same predictive distribution of a new effect as presented by the ERG. Therefore, I believe the ERG did, in their modelling, put the prior on the sd, while the text contains a slight error.


```{r}
erg_priors <- list(
  prior.fe.mean = boot::logit(0.3),
  prior.fe.prec = 1/10,
  prior.re.lo = 0,
  prior.re.up = 5
)
```

Fit the random effects MA model used by the ERG.
```{r}
set.seed(r_seed)
fit_re <- jags(data = c(djags, erg_priors),
               n.chains = n_chains,
               n.iter = n_iter,
               n.burnin = n_burnin,
               n.thin = n_thin,
               parameters = c(pars_fe, "re.sd"),
               inits = NULL,
               model.file = "models/bin_abs_re_unif.jgmod")
```


__Results: reproducing the ERG analysis__

```{r}
# extract results and derive summaries needed later on for tables and figures

## print the (BUGS) output summaries: RE model
# fit_re

## summaries as in forest plots
sum_re <- get_bin_forestdata(fit_re, node.stem = "p", study.labs = dorr_erg$`Tumour type`)

## threshold probabilities
p_better_re <- get_bin_threshold(fit_re, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                 node.stem = "p", node.extras = c(".pop", ".new"), 
                                 study.labs = dorr_erg$`Tumour type`)

## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re, 
                         node.stem = "p", 
                         study.labs = dorr_erg$`Tumour type`, 
                         var.name = "Tumour_type")

## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")
```


__Table__ Reproducing ERG analysis: Study specific estimates
```{r, results='asis'}
pander::pandoc.table(sum_re, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ Reproducing ERG analysis: Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```

__Table__ Reproducing ERG analysis: Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re, row.names = FALSE, split.tables = Inf, digits = 3, justify = "left")
```


__Figure__ Reproducing ERG analysis: Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


__Figure__ Reproducing ERG analysis: Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = c(erg_priors$prior.re.lo, erg_priors$prior.re.up),
                     y = rep(1/diff(c(erg_priors$prior.re.lo, erg_priors$prior.re.up)), 2))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, fig)
```



# For comparison: corresponding fixed effect model
```{r}
set.seed(r_seed)
fit_fe <- jags(data = c(djags, erg_priors[1:2]),
               n.chains = n_chains,
               n.iter = n_iter,
               n.burnin = n_burnin,
               n.thin = n_thin,
               parameters = pars_fe,
               inits = NULL,
               model.file = "models/bin_abs_fe.jgmod")
```

__Results: FE model__

```{r}
## print the (BUGS) output summaries: RE model
# fit_fe

## summaries as in forest plots
sum_fe <- get_bin_forestdata(fit_fe, node.stem = "p", study.labs = dorr_erg$`Tumour type`)

## threshold probabilities
p_better_fe <- get_bin_threshold(fit_fe, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                 node.stem = "p", node.extras = c(".pop", ".new"), 
                                 study.labs = dorr_erg$`Tumour type`)

```


__Table__ FE model estimates
```{r, results='asis'}
pander::pandoc.table(sum_fe, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ FE model: Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_fe %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```

__Table__ FE model: Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_fe, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ FE model: Density estimates of response probability per tissue
```{r}
dsims <- get_bin_samples(fit_fe, 
                         node.stem = "p", 
                         study.labs = dorr_erg$`Tumour type`, 
                         var.name = "Tumour_type")

fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


# Analysis with alternative prior
Use the same priors for the population mean mu, but instead of the U(0,5) for RE SD, use a half-normal(0,1).

```{r}
my_priors <- list(
  prior.fe.mean = boot::logit(0.3),
  prior.fe.prec = 1/10,
  prior.re.mean = 0,
  prior.re.prec = 1
)
  
set.seed(3 * r_seed)
fit_re_hn <- jags(data = c(djags, my_priors),
               n.chains = n_chains,
               n.iter = n_iter,
               n.burnin = n_burnin,
               n.thin = n_thin,
               parameters = c(pars_fe, "re.sd"),
               inits = NULL,
               model.file = "models/bin_abs_re_hn.jgmod")
```


__Results: Alternative RE prior__

```{r}
## print the (BUGS) output summaries: RE model
# fit_re_hn

## summaries as in forest plots
sum_re_hn <- get_bin_forestdata(fit_re_hn, node.stem = "p", study.labs = dorr_erg$`Tumour type`)

## threshold probabilities
p_better_re_hn <- get_bin_threshold(fit_re_hn, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_erg$`Tumour type`)

## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_hn, 
                         node.stem = "p", 
                         study.labs = dorr_erg$`Tumour type`, 
                         var.name = "Tumour_type")


## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_hn, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ Alternative RE prior: response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_hn, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ Alternative RE prior: Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_hn %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ Alternative RE prior: Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_hn, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ Alternative RE prior: Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


__Figure__ Alternative RE prior: Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = seq(0, 5, 0.1)) %>%
  mutate(y = 2 * dnorm(x, 
                       mean = my_priors$prior.re.mean, 
                       sd = sqrt(1/my_priors$prior.re.prec)))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, fig)
```


# Analysis with reduced data set (but with ERG prior)
ERG model applied to a reduced data set: contains only tissue types with at least 1 event and 1 non-event. This means the analysis data set is the following.

__Table__ ORR data (reduced set)
```{r, results='asis'}
dorr_sub <- dorr_erg %>%
  filter(x >= 1, n - x >= 1)

pander::pandoc.table(dorr_sub, row.names = FALSE, split.tables = Inf, justify = "lrlr", digits = 2)
```


```{r}
djags_sub <- list(ns = nrow(dorr_sub),
                  r = dorr_sub$x,
                  n = dorr_sub$n)

set.seed(4 * r_seed)
fit_re_sub <- jags(data = c(djags_sub, erg_priors),
                   n.chains = n_chains,
                   n.iter = n_iter,
                   n.burnin = n_burnin,
                   n.thin = n_thin,
                   parameters = c(pars_fe, "re.sd"),
                   inits = NULL,
                   model.file = "models/bin_abs_re_unif.jgmod")
```


__Results: Reduced data set__

```{r}
## summaries as in forest plots
sum_re_sub <- get_bin_forestdata(fit_re_sub, node.stem = "p", study.labs = dorr_sub$`Tumour type`)

## threshold probabilities
p_better_re_sub <- get_bin_threshold(fit_re_sub, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_sub$`Tumour type`)

## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_sub, 
                         node.stem = "p", 
                         study.labs = dorr_sub$`Tumour type`, 
                         var.name = "Tumour_type")

## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_sub, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ Reduced data set: response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_sub, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ Reduced data set: Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_sub %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ Reduced data set: Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_sub, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ Reduced data set: Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```

__Figure__ Reduced data set: Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = c(erg_priors$prior.re.lo, erg_priors$prior.re.up),
                     y = rep(1/diff(c(erg_priors$prior.re.lo, erg_priors$prior.re.up)), 2))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, fig)
```


# Analysis with reduced data set and with my prior

```{r}
set.seed(5 * r_seed)
fit_re_sub_hn <- jags(data = c(djags_sub, my_priors),
                   n.chains = n_chains,
                   n.iter = n_iter,
                   n.burnin = n_burnin,
                   n.thin = n_thin,
                   parameters = c(pars_fe, "re.sd"),
                   inits = NULL,
                   model.file = "models/bin_abs_re_hn.jgmod")
```


__Results: Reduced data set and alternative RE prior__

```{r}
## summaries as in forest plots
sum_re_sub_hn <- get_bin_forestdata(fit_re_sub_hn, node.stem = "p", study.labs = dorr_sub$`Tumour type`)

## threshold probabilities
p_better_re_sub_hn <- get_bin_threshold(fit_re_sub_hn, thresholds = c(0.1, 0.2, 0.3, 0.5), 
                                    node.stem = "p", node.extras = c(".pop", ".new"), 
                                    study.labs = dorr_sub$`Tumour type`)
## data frame with the MCMC iterations: response rates
dsims <- get_bin_samples(fit_re_sub_hn, 
                         node.stem = "p", 
                         study.labs = dorr_sub$`Tumour type`, 
                         var.name = "Tumour_type")

## data frame with the MCMC iterations: re.sd (to compare prior/posterior)
dsims_re <- get_bin_samples(fit_re_sub_hn, 
                         node.stem = "re.sd", 
                         node.extras = NULL,
                         val.name = "re.sd")

```


__Table__ Reduced data set and alternative RE prior: response estimates
```{r, results='asis'}
pander::pandoc.table(sum_re_sub_hn, row.names = FALSE, split.tables = Inf, justify = "lccc", digits = 2)
```

__Figure__ Reduced data set and alternative RE prior: Forest plot
```{r, fig.height=4, fig.width=7}
dfig <- sum_re_sub_hn %>%
  mutate(ro = n():1)
fig <- plot_bin_forest(dfig, x.lab = "Response probability", y.lab = "Tissue")
fig

rm(fig, dfig)
```


__Table__ Reduced data set and alternative RE prior: Threshold probabilities
```{r, results='asis'}
pander::pandoc.table(p_better_re_sub_hn, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)
```


__Figure__ Reduced data set and alternative RE prior: Density estimates of response probability per tissue
```{r}
fig <- ggplot(data = dsims %>% filter(!(Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value)) +
  facet_wrap(~Tumour_type, ncol = 4) +
  xlab("Response probability") +
  theme_bw()
fig

fig <- ggplot(data = dsims %>% filter((Tumour_type %in% c("p.pop", "p.new")))) +
  geom_density(aes(value, fill = Tumour_type), alpha = 0.5) +
  xlab("Response probability") +
  theme_bw()
fig

rm(dsims, fig)
```


__Figure__ Reduced data set and alternative RE prior: Prior and posterior of random effect standard deviation
```{r}
dprior <- data.frame(x = seq(0, 5, 0.1)) %>%
  mutate(y = 2 * dnorm(x, 
                       mean = my_priors$prior.re.mean, 
                       sd = sqrt(1/my_priors$prior.re.prec)))

fig <- ggplot(data = dsims_re) +
  geom_density(aes(re.sd), fill = 2, alpha = 0.5, lwd = 1.2) +
  geom_line(data = dprior, aes(x, y), linetype = "dashed", lwd = 1.2) +
  theme_bw()
fig

rm(dsims_re, fig)
```


# Compare posterior inferences across RE fits
```{r}
allfits <- list("ERG" = fit_re,
                "Alternative heterogeneity prior (HN)" = fit_re_hn,
                "Reduced data set" = fit_re_sub,
                "Reduced data set and alterantive prior" = fit_re_sub_hn)

## function to extract 95% CrI, quartiles, and median
get_quantiles <- function(X, node){
  sd <- X$BUGSoutput$sims.list[[node]]
  qs <- quantile(sd, probs = c(0.025, 0.25, 0.5, 0.75, 0.975))
  IQR <- qs[4] - qs[2]
  CrI.range <- qs[5] - qs[1]
  out <- data.frame(t(qs), IQR, CrI.range, check.names = FALSE)
  return(out)
}
```


__Table__ Compare RE SD posterior summaries across models
```{r}
## re.se posterior summaries
post_slist <- lapply(allfits, get_quantiles, node = "re.sd")
post_mat <- matrix(unlist(post_slist),
                     nrow = length(allfits),
                     byrow = TRUE)
post_all <- data.frame(Model = names(allfits), 
                         post_mat)
names(post_all)[-1] <- names(post_slist[[1]])

pander::pandoc.table(post_all, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)

rm(post_slist, post_mat, post_all)
```


__Table__ Compare p.new posterior summaries across models
```{r}
## p.new posterior summaries
post_slist <- lapply(allfits, get_quantiles, node = "p.new")
post_mat <- matrix(unlist(post_slist),
                     nrow = length(allfits),
                     byrow = TRUE)
post_all <- data.frame(Model = names(allfits), 
                         post_mat)
names(post_all)[-1] <- names(post_slist[[1]])

pander::pandoc.table(post_all, row.names = FALSE, split.tables = Inf, justify = "left", digits = 3)

rm(post_slist, post_mat, post_all)
```


# Session info
```{r}
getwd()
sessionInfo()
```
